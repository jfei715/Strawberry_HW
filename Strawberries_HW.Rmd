---
title: "Strawberries_HW"
author: "Jie Fei"
date: "2024-10-15"
output:
  pdf_document: default
  html_document: default
---

Data cleaning and organization

```{r}
library(knitr)  
library(kableExtra)
library(tidyverse)
library(stringr)

# Read the strawberry data
strawberry <- read_csv("strawberries25_v3.csv", col_names = TRUE)
glimpse(strawberry)
```

Examine the data. How is it organized?

```{r}
# Is every line associated with a state?
state_all <- strawberry |> distinct(State)
state_all1 <- strawberry |> group_by(State) |> count()

# Every row is associated with a state
sum(state_all1$n) == dim(strawberry)[1]

# To get an idea of the data -- looking at california only
calif_census <- strawberry |> filter((State == "CALIFORNIA") & (Program == "CENSUS"))
calif_census <- calif_census |> select(Year, `Data Item`, Value)

calif_survey <- strawberry |> filter((State == "CALIFORNIA") & (Program == "SURVEY"))
calif_survey <- strawberry |> select(Year, Period, `Data Item`, Value)
```

Remove columns with a single value in all columns

```{r}
drop_one_value_col <- function(df){
drop <- NULL
for(i in 1:dim(df)[2]){
if((df |> distinct(df[,i]) |> count()) == 1){
drop = c(drop, i)
} }

if(is.null(drop)){return("none")}else{

   print("Columns dropped:")
   print(colnames(df)[drop])
   strawberry <- df[, -1*drop]
   }
}

# Use the function

strawberry <- drop_one_value_col(strawberry)
drop_one_value_col(strawberry)
```

Separate composite columns

```{r}
strawberry <- strawberry |>
separate_wider_delim( cols = `Data Item`,
                      delim = ",",
                      names = c("Fruit",
                                 "Category",
                                 "Item",
                                 "Metric"),
                      too_many = "error",
                      too_few = "align_start"
                    )
```

Fix the leading space problem

```{r}
strawberry$Category[1]

# Trim white space 
strawberry$Category <- str_trim(strawberry$Category, side = "both")
strawberry$Item <- str_trim(strawberry$Item, side = "both")
strawberry$Metric <- str_trim(strawberry$Metric, side = "both")
```

Exam the fruit column and find hidden sub-columns

```{r}
unique(strawberry$Fruit)

# Generate a list of rows with the production and price information
spr <- which((strawberry$Fruit == "STRAWBERRIES - PRODUCTION") | (strawberry$Fruit == "STRAWBERRIES - PRICE RECEIVED"))
strw_prod_price <- strawberry |> slice(spr)

# This has the census data, too
strw_chem <- strawberry |> slice(-1*spr)  ## too soon
```

Exam the rest of columns and split sales and chemicals into two dataframes

```{r}
strw_b_sales <- strawberry |> filter(Program == "CENSUS")
strw_b_chem <- strawberry |> filter(Program == "SURVEY")
nrow(strawberry) == (nrow(strw_b_chem) + nrow(strw_b_sales))
```

Export the cleaned strawberry data

```{r}
write.csv(strawberry, "cleaned_strawberry.csv", row.names = FALSE)
```

Data analysis and plots

```{r}
# Number of organic strawberry operations with sales in 2021
plot1_data <- strawberry |> 
  select(c(Year, State, Category, Value)) |> 
  filter((Year == 2021) & (Category == "ORGANIC - OPERATIONS WITH SALES"))

plot1_data$Value <- as.numeric(plot1_data$Value)

plot1_data <- plot1_data |> arrange(desc(Value))

ggplot(plot1_data, aes(x = reorder(State, -Value), y = Value)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
  labs(x = "States", y = "Count",
title = "Number of Organic Strawberry operations with Sales in 2021")
```

```{r}
# Organic strawberry sales ($) in 2021
plot2_data <- strawberry |> 
  select(c(Year, State, Category, Item, Value)) |> 
  filter((Year == 2021) & 
           (Category == "ORGANIC - SALES") & 
           (Item == "MEASURED IN $") & 
           (Value != "(D)"))

plot2_data$Value <- as.numeric(gsub(",", "", plot2_data$Value))

plot2_data <- plot1_data |> arrange(desc(Value))

ggplot(plot2_data, aes(x = reorder(State, -Value), y = Value)) + 
  geom_bar(stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
  labs(x = "States", y = "Sales",
title = "Organic Strawberry Sales ($) in 2021")
```

```{r}
# Summary statistics by category and state
summary_data <- strawberry %>%
  group_by(State, Fruit) %>%
  summarise(total_value = sum(as.numeric(Value), na.rm = TRUE)) %>%
  arrange(desc(total_value))

print(summary_data)
```

```{r}
# Pie chart: proportion of strawberry operations per fruit category
pie_data <- strawberry %>%
  group_by(Fruit) %>%
  summarise(total_value = sum(as.numeric(Value), na.rm = TRUE))

ggplot(pie_data, aes(x = "", y = total_value, fill = Fruit)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y") +
  labs(title = "Proportion of Strawberry Operations per Category") +
  theme_void()
```

```{r}
# Scatter plot: comparing operations across states
ggplot(strawberry, aes(x = State, y = as.numeric(Value), color = Fruit)) +
  geom_point() +
  labs(title = "Comparison of Strawberry Operations Across States", x = "State", y = "Operations") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

